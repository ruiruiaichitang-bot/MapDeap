// pages/SpotDetailPage.ets
import { router } from '@kit.ArkUI';
import { webview } from '@kit.ArkWeb';

// å®šä¹‰æˆ‘ä»¬æœŸæœ›æ¥æ”¶çš„å‚æ•°ç»“æ„
interface RouterParams {
  id: number;
  title: string;
  location: string;
  image: string | Resource;
  detailUrl: string;
}

@Entry
@ComponentV2
  // ğŸ‘ˆ äº®ç‚¹ï¼šè¿™æ˜¯ V2 ç‰ˆæœ¬çš„ç»„ä»¶æ ‡å¿—
struct SpotDetailPage {
  // V2 æ–°è¯­æ³•ï¼šä½¿ç”¨ @Local ä»£æ›¿ @State ç®¡ç†ç»„ä»¶å†…éƒ¨çŠ¶æ€
  @Local title: string = 'æ™¯ç‚¹è¯¦æƒ…';
  @Local location: string = '';
  @Local imageId: number = 0;
  @Local image: string | Resource = '';
  @Local isLiked: boolean = false; // ç‚¹èµçŠ¶æ€
  @Local topHeight: number = 0;
  @Local isDarkMode: boolean = false;
  @Local spotId: number = 0;
  @Local detailUrl: string = '';
  //webæ§åˆ¶å™¨
  private webController: webview.WebviewController = new webview.WebviewController();

  // é¡µé¢åŠ è½½æ—¶è§¦å‘
  aboutToAppear(): void {
    // è·å–ä¸Šä¸€é¡µä¼ è¿‡æ¥çš„å‚æ•°
    const params = router.getParams() as RouterParams;
    if (params) {
      this.spotId = params.id
      this.title = params.title;
      this.location = params.location;
      // this.imageId = params.id;
      this.image = params.image;
      this.detailUrl = params.detailUrl || 'https://www.harmonyos.com';
    }
    this.topHeight = AppStorage.get<number>('topHeight') || 0;
    this.isDarkMode = AppStorage.get<boolean>('isDarkMode') || false;
  }

  build() {
    Column() {
      // --- 1. é¡¶éƒ¨å¯¼èˆªæ  ---
      Row() {
        // è¿”å›ç®­å¤´
        Text('<')
          .fontSize(30)
          .padding({ left: 16, right: 16 })
          .fontColor(this.isDarkMode ? Color.White : Color.Black)
          .onClick(() => {
            router.back(); // ğŸ‘ˆ è¿”å›ä¸Šä¸€é¡µ
          })

        Text(this.title)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isDarkMode ? Color.White : Color.Black)
          .layoutWeight(1) // æ’‘æ»¡ä¸­é—´
          .textAlign(TextAlign.Center) // æ–‡å­—å±…ä¸­

        // å ä½ç¬¦ï¼Œä¸ºäº†è®©æ ‡é¢˜è§†è§‰å±…ä¸­
        Text('  ').width(50)
      }
      .height(56)
      .width('100%')
      .border({ width: { bottom: 1 }, color: '#EEE' })

      // --- 2. å†…å®¹åŒºåŸŸ ---
      Column({ space: 20 }) {
        // å¤§å›¾
        Image(this.image) // æš‚æ—¶è¿˜ç”¨è¿™ä¸ªå›¾ï¼Œä»¥åæ¢
          .width('100%')
          .height(250)
          .objectFit(ImageFit.Cover)
          .borderRadius(16)
          .shadow({ radius: 10, color: '#33000000' })
          .sharedTransition('hero_' + this.spotId, { duration: 400, curve: Curve.Smooth })


        // åœ°ç‚¹ä¿¡æ¯
        Row() {
          Text('ğŸ“ ' + this.location)
            .backgroundColor(this.isDarkMode ? '#333' : '#F5F5F5')
            .fontSize(16)
            .fontColor('#666')
            // .backgroundColor('#F5F5F5')
            .padding({
              left: 10,
              right: 10,
              top: 6,
              bottom: 6
            })
            .borderRadius(20)
        }
        .width('100%')

        // ä»‹ç»æ–‡æ¡ˆ
        Column() {
          if (this.detailUrl) {
            Web({
              src: this.detailUrl,
              controller: this.webController
            })
              .width('100%')
              // è®©å®ƒå¡«æ»¡å‰©ä½™ç©ºé—´
              .layoutWeight(1)
              // å…è®¸ç¼©æ”¾
              .zoomAccess(false)
              // å¼€å¯å¤œé—´æ¨¡å¼é€‚é… (å¯é€‰)
              .darkMode(WebDarkMode.Auto)
          }
        }.width('100%')
        .layoutWeight(1) // è®© Web åŒºåŸŸæ’‘æ»¡å±å¹•å‰©ä¸‹çš„éƒ¨åˆ†

        // --- 3. äº’åŠ¨æŒ‰é’® (æµ‹è¯• V2 çŠ¶æ€) ---
        Button(this.isLiked ? 'å·²æ”¶è— â¤ï¸' : 'æ”¶è—æ™¯ç‚¹ ğŸ¤')
          .onClick(() => {
            this.isLiked = !this.isLiked; // ç›´æ¥ä¿®æ”¹ï¼ŒUI è‡ªåŠ¨åˆ·æ–°
          })
          .width('100%')
          .height(45)
          .backgroundColor(this.isLiked ? '#FFEBEE' : '#222')
          .fontColor(this.isLiked ? Color.Red : Color.White)
          .margin({ top: 20 })
      }
      .padding(20)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.isDarkMode ? '#121212' : Color.White)
    .padding({ top: px2vp(this.topHeight) })
  }
}