// views/HomeView.ets
import { router } from '@kit.ArkUI';
import { SpotModel } from '../model/SpotModel';
import { SpotApi } from '../api/SpotApi';

@Component
export struct HomeView {
  // çŠ¶æ€å˜é‡æ¬è¿‡æ¥
  @State spotList: SpotModel[] = [];
  @State isLoading: boolean = true;
  @StorageProp('isDarkMode') isDarkMode: boolean = false;
  // è‡ªåŠ¨è·å–ä¹‹å‰çš„å®‰å…¨åŒºåŸŸé«˜åº¦
  @StorageProp('topHeight') topHeight: number = 0;
  //è½®æ’­å›¾çš„æ•°æ®
  @State banners: string[] = [
    'https://img.freepik.com/free-photo/nature-landscape-with-hand-holding-frame_23-2149389976.jpg?t=st=1768881010~exp=1768884610~hmac=838377f7ce2d88ed5a575aadaa0a4a3053c3bebd836105a24eeab2a2fcac6196&w=1060',
    'https://img.freepik.com/free-photo/professional-photographer-takes-photos-with-camera-tripod-rocky-peak-sunset_335224-433.jpg?t=st=1768881113~exp=1768884713~hmac=6c395f9a4f2ad35f1a6b1d6b95bc6c6e9792e41585241d07a2a7bfe9bcb47bab&w=1060',
    'https://img.freepik.com/free-photo/beautiful-landscape-mountain-fuji-around-yamanakako-lake_74190-3041.jpg?t=st=1768881136~exp=1768884736~hmac=04526167d459b2a7c5f518e1aa5afd11a606cbfb90f674209e93198c55cd117c&w=1060'
  ];
  //æ§åˆ¶åˆ·æ–°
  @State isRefreshing: boolean = false;

  async aboutToAppear() {
    try {
      this.spotList = await SpotApi.getSpotList();
    } catch (error) {
      console.error('API Error', JSON.stringify(error));
    } finally {
      this.isLoading = false;
    }
  }

  @Builder
  SpotCard(item: SpotModel) {
    Column() {
      Image(item.image)
        .width('100%')
        .height(150)
        .backgroundColor('#E0E0E0')
        .objectFit(ImageFit.Cover)
        .borderRadius({ topLeft: 12, topRight: 12 })
        .sharedTransition('hero_' + item.id, { duration: 400, curve: Curve.Smooth })

      Column() {
        Text(item.title).fontSize(16).fontWeight(FontWeight.Bold)
        Text(item.location).fontSize(12).fontColor('#999').margin({ top: 5 })
      }
      .padding(10)
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 5, color: '#1A000000', offsetY: 2 })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/SpotDetailPage',
        params: {
          id: item.id,
          title: item.title,
          location: item.location,
          image: item.image,
          detailUrl: item.detailUrl
        }
      })
    })
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('æ™ºè¡Œå±±æµ·')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 10, left: 16 })
        .width('100%')
        .fontColor(this.isDarkMode ? Color.White : Color.Black)

      // è½®æ’­å›¾

      Swiper() {
        ForEach(this.banners, (img: string) => {
          Image(img)
            .width('100%')
            .height('100%')
            .objectFit(ImageFit.Cover) // å¡«æ»¡ä¸ç•™ç™½
            .borderRadius(16) // åœ†è§’
        })
      }
      .effectMode(EdgeEffect.Spring)
      .width('100%')
      .height(180)
      .autoPlay(true)
      .interval(3000)
      .indicator(true)
      .itemSpace(10)
      .padding({ left: 16, right: 16 })
      .margin({ bottom: 10 })

      // ç€‘å¸ƒæµ

      Refresh({ refreshing: $$this.isRefreshing }) {
        WaterFlow() {
          ForEach(this.spotList, (item: SpotModel) => {
            FlowItem() {
              this.SpotCard(item)
            }
          }, (item: SpotModel) => item.id.toString())
        }
        .columnsTemplate("1fr 1fr")
        .columnsGap(10)
        .rowsGap(10)
        .padding({ left: 10, right: 10, bottom: 20 })
        // .layoutWeight(1)
        .height('100%')
      }
      .layoutWeight(1)
      .onRefreshing(() => {
        // ğŸ‘‡ å½“ç”¨æˆ·ä¸‹æ‹‰æ—¶ï¼Œè§¦å‘è¿™ä¸ªå‡½æ•°

        // 1. é‡æ–°è¯·æ±‚æ•°æ®
        SpotApi.getSpotList().then((newList) => {
          // 2. ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬è¦ä¹ˆæŠŠåˆ—è¡¨æ¸…ç©ºå†èµ‹å€¼ï¼Œè¦ä¹ˆæ‰“ä¹±ä¸€ä¸‹é¡ºåº
          // è¿™é‡Œæˆ‘ä»¬ç®€å•ç²—æš´ï¼šç›´æ¥è¦†ç›– (å®é™…å¼€å‘ä¸­å¯èƒ½æ˜¯è¿½åŠ æˆ–æ›¿æ¢)
          this.spotList = newList;

          // 3. å‘Šè¯‰ç³»ç»Ÿï¼šåˆ·æ–°å®Œäº†ï¼ŒæŠŠè½¬åœˆåœˆæ”¶å›å»
          this.isRefreshing = false;

          // ğŸ’¡ æç¤ºç”¨æˆ· (å¯é€‰)
          // Prompt.showToast({ message: 'åˆ·æ–°æˆåŠŸ' });
        }).catch(() => {
          this.isRefreshing = false; // å³ä½¿å¤±è´¥ä¹Ÿè¦å…³é—­åŠ¨ç”»
        });
      })
    }
    .height('100%')
    .backgroundColor(this.isDarkMode ? '#121212' : '#F1F3F5')
    // ğŸ‘‡ å…³é”®ï¼šåœ¨è¿™é‡Œåº”ç”¨é¡¶éƒ¨çš„é¿è®©é«˜åº¦
    .padding({ top: px2vp(this.topHeight) })
  }
}