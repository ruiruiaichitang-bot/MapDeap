// views/HomeView.ets
import { router } from '@kit.ArkUI';
import { SpotModel } from '../model/SpotModel';
import { SpotApi } from '../api/SpotApi';

@Component
export struct HomeView {
  // çŠ¶æ€å˜é‡æ¬è¿‡æ¥
  @State spotList: SpotModel[] = [];
  @State isLoading: boolean = true;
  @StorageProp('isDarkMode') isDarkMode: boolean = false;

  // è‡ªåŠ¨è·å–ä¹‹å‰çš„å®‰å…¨åŒºåŸŸé«˜åº¦
  @StorageProp('topHeight') topHeight: number = 0;

  // ç”Ÿå‘½å‘¨æœŸæ¬è¿‡æ¥
  async aboutToAppear() {
    try {
      this.spotList = await SpotApi.getSpotList();
    } catch (error) {
      console.error('API Error', JSON.stringify(error));
    } finally {
      this.isLoading = false;
    }
  }

  // å¡ç‰‡å¸ƒå±€æ¬è¿‡æ¥
  @Builder SpotCard(item: SpotModel) {
    Column() {
      Image(item.image)
        .width('100%')
        .height(150)
        .backgroundColor('#E0E0E0')
        .objectFit(ImageFit.Cover)
        .borderRadius({ topLeft: 12, topRight: 12 })
        .sharedTransition('hero_' + item.id, { duration: 400, curve: Curve.Smooth })

      Column() {
        Text(item.title).fontSize(16).fontWeight(FontWeight.Bold)
        Text(item.location).fontSize(12).fontColor('#999').margin({ top: 5 })
      }
      .padding(10)
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 5, color: '#1A000000', offsetY: 2 })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/SpotDetailPage',
        params: { id: item.id, title: item.title, location: item.location, image: item.image }
      })
    })
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('æ™ºè¡Œå±±æµ·')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 10, left: 16 })
        .width('100%')
        .fontColor(this.isDarkMode ? Color.White : Color.Black)

      // ç€‘å¸ƒæµ
      WaterFlow() {
        ForEach(this.spotList, (item: SpotModel) => {
          FlowItem() {
            this.SpotCard(item)
          }
        }, (item: SpotModel) => item.id.toString())
      }
      .columnsTemplate("1fr 1fr")
      .columnsGap(10)
      .rowsGap(10)
      .padding({ left: 10, right: 10, bottom: 20 })
      .height('100%')
    }
    .height('100%')
    .backgroundColor(this.isDarkMode ? '#121212' : '#F1F3F5')
    // ğŸ‘‡ å…³é”®ï¼šåœ¨è¿™é‡Œåº”ç”¨é¡¶éƒ¨çš„é¿è®©é«˜åº¦
    .padding({ top: px2vp(this.topHeight) })
  }
}